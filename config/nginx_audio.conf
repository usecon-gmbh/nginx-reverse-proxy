worker_processes auto;
worker_rlimit_nofile 65535;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 10240;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type text/plain;

    log_format compact '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                       'rt=$request_time uht="$upstream_header_time" urt="$upstream_response_time" '
                       'cs=$upstream_cache_status';
    access_log /var/log/nginx/access.log compact buffer=16k flush=5s;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 75;
    keepalive_requests 1000;
    reset_timedout_connection on;
    server_tokens off;

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=app_cache:200m max_size=50g
                     inactive=10d use_temp_path=off;

    server {
        listen 8080 default_server;
        server_name _;

        # Health & root
        location = /health { access_log off; add_header Content-Type text/plain; return 200 "OK\n"; }
        location = /       { add_header Content-Type text/plain; return 200 "Audio is alive!\n"; }
        location = /favicon.ico { access_log off; log_not_found off; return 204; }
        location = /robots.txt  { access_log off; add_header Content-Type text/plain; return 200 "User-agent: *\nDisallow: /\n"; }

        error_page 404 = @404;
        error_page 500 502 503 504 = @50x;

        location = /test {
            default_type application/json;
            add_header Access-Control-Allow-Origin * always;
            return 200 '{"message": "This is a test"}';
        }

        # Common error handlers
        location @404 {
            internal;
            default_type text/html;
            add_header Cache-Control "no-store" always;
            add_header X-Error "404" always;
            return 404 '<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Not Found</title><style>html,body{height:100%;margin:0}body{display:grid;place-items:center;}main{max-width:42rem;text-align:center;}</style><main><h1>404 — Not found</h1><p>We couldn’t find <code>$request_uri</code> on <code>$host</code>.</p><p>Request ID: <code>$request_id</code></p></main></html>';
        }

        location @50x {
            internal;
            default_type text/html;
            add_header Cache-Control "no-store" always;
            add_header Retry-After 5 always;
            add_header X-Error "5xx" always;
            return 503 '<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Service unavailable</title><style>html,body{height:100%;margin:0}body{display:grid;place-items:center;}main{max-width:42rem;text-align:center;}</style><main><h1>We&apos;ll be right back</h1><p>Upstream is currently unavailable. Please try again in a moment.</p><p>Request ID: <code>$request_id</code></p></main></html>';
        }
    }
}